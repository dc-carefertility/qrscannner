<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QR Code Scanner Enhanced</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
          integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; position: relative; }
    #reader { width: 100%; max-width: 480px; margin: 20px auto; display: none; }
    #output { margin-top: 20px; font-size: 1.2em; font-weight: bold; word-break: break-word; }
    #cameraSelect, button { margin: 5px; padding: 8px 12px; font-size: 1em; }
    #controls { margin: 15px 0; }
    #log {
      margin-top: 20px;
      text-align: left;
      background: #f0f0f0;
      border: 1px solid #ccc;
      padding: 10px;
      max-height: 150px;
      overflow-y: auto;
      font-size: 0.85em;
      white-space: pre-wrap;
    }
    #version {
      position: fixed;
      top: 10px;
      right: 10px;
      background: #333;
      color: #fff;
      padding: 4px 8px;
      font-size: 0.8em;
      border-radius: 4px;
      opacity: 0.8;
    }
  </style>
</head>
<body>
  <!-- ✅ Version badge -->
  <div id="version">v0.0.11</div>

  <h1>QR Code Scanner</h1>

  <div id="controls">
    <select id="cameraSelect"></select>
    <button id="startBtn">Start Scanning</button>
    <button id="stopBtn" style="display:none;">Scan New QR</button>
    <button id="torchBtn" style="display:none;">Toggle Torch</button>
    <button id="focusBtn" style="display:none;">Refocus</button>
  </div>

  <div id="reader"></div>
  <div id="output">Idle…</div>
  <div id="log">[Debug log]</div>

  <script>
    // If you want to easily change version, just edit the textContent below
    document.getElementById('version').textContent = 'v0.0.11';

    let html5QrCode;
    let currentCameraId = null;
    let scanning = false;
    let torchOn = false;

    const logDiv = document.getElementById('log');
    const outputDiv = document.getElementById('output');
    const readerDiv = document.getElementById('reader');
    const cameraSelect = document.getElementById('cameraSelect');
    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const torchBtn = document.getElementById('torchBtn');
    const focusBtn = document.getElementById('focusBtn');

    function log(msg) {
      logDiv.textContent += `\n${msg}`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function populateCameras(devices) {
      cameraSelect.innerHTML = '';
      devices.forEach((device, idx) => {
        const opt = document.createElement('option');
        opt.value = device.id;
        opt.text = device.label || `Camera ${idx + 1}`;
        cameraSelect.appendChild(opt);
      });

      // Restore last used camera
      const savedCam = localStorage.getItem('lastCameraId');
      if (savedCam && devices.find(d => d.id === savedCam)) {
        cameraSelect.value = savedCam;
      }
    }

    function onScanSuccess(decodedText) {
      if (!scanning) return;
      scanning = false;
      outputDiv.textContent = `✅ Scanned: ${decodedText}`;
      log(`Decoded: ${decodedText}`);
      stopScanner();
    }

    function onScanFailure(err) {
      // frequent failures expected
    }

    function startScanner() {
      currentCameraId = cameraSelect.value;
      localStorage.setItem('lastCameraId', currentCameraId);

      if (!html5QrCode) {
        html5QrCode = new Html5Qrcode("reader");
      }

      log(`Starting camera: ${currentCameraId}`);
      html5QrCode.start(
        currentCameraId,
        { fps: 10, qrbox: { width: 300, height: 300 } },
        onScanSuccess,
        onScanFailure
      ).then(() => {
        scanning = true;
        readerDiv.style.display = 'block';
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        torchBtn.style.display = 'inline-block';
        focusBtn.style.display = 'inline-block';
        outputDiv.textContent = 'Scanning…';
      }).catch(err => {
        log(`Start error: ${err}`);
        outputDiv.textContent = `Start error: ${err}`;
      });
    }

    function stopScanner() {
      if (html5QrCode) {
        html5QrCode.stop().then(() => {
          readerDiv.style.display = 'none';
          startBtn.style.display = 'inline-block';
          stopBtn.style.display = 'none';
          torchBtn.style.display = 'none';
          focusBtn.style.display = 'none';
          log('Camera stopped.');
        }).catch(err => log(`Error stopping: ${err}`));
      }
    }

    async function toggleTorch() {
      if (!html5QrCode) return;
      try {
        torchOn = !torchOn;
        await html5QrCode.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
        log(`Torch ${torchOn ? 'ON' : 'OFF'}`);
      } catch (e) {
        log('Torch not supported: ' + e);
      }
    }

    async function requestFocus() {
      if (!html5QrCode) return;
      try {
        await html5QrCode.applyVideoConstraints({ advanced: [{ focusMode: "continuous" }] });
        log('Focus requested (support varies)');
      } catch (e) {
        log('Focus not supported: ' + e);
      }
    }

    // Event bindings
    startBtn.addEventListener('click', startScanner);
    stopBtn.addEventListener('click', () => {
      outputDiv.textContent = 'Idle…';
      stopScanner();
    });
    torchBtn.addEventListener('click', toggleTorch);
    focusBtn.addEventListener('click', requestFocus);

    // Populate cameras on load
    Html5Qrcode.getCameras().then(devices => {
      if (devices && devices.length) {
        populateCameras(devices);
      } else {
        outputDiv.textContent = 'No cameras found.';
        log('No cameras found.');
      }
    }).catch(err => {
      outputDiv.textContent = 'Camera error: ' + err;
      log('Camera error: ' + err);
    });
  </script>
</body>
</html>
