<!doctype html>
<html lang="en">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sound detector → Power Automate (Teams Alert)</title>
<style>
  :root { --warn:#b71c1c; }
  body { font-family: system-ui, Arial, sans-serif; max-width: 720px; margin: 2rem auto; padding: 0 1rem; }
  fieldset { margin: 1rem 0; }
  label { display:block; margin:.5rem 0 .25rem; }
  input[type="number"] { width: 100%; padding:.5rem; }
  .row { display:flex; gap:1rem; flex-wrap:wrap; }
  .row > div { flex:1 1 200px; }
  .status { margin-top:.5rem; font-size:.9rem; opacity:.85; }
  button { padding:.6rem 1rem; }
  meter { width:100%; height:1rem; }
  .alert { display:none; margin:1rem 0; padding:.75rem 1rem; background:#ffebee; color:var(--warn); border:1px solid var(--warn); border-radius:8px; font-weight:600; animation:pulse 1.2s infinite; }
  .alert.on { display:block; }
  @keyframes pulse { 0%{box-shadow:0 0 0 0 rgba(183,28,28,.35)} 70%{box-shadow:0 0 0 14px rgba(183,28,28,0)} 100%{box-shadow:0 0 0 0 rgba(183,28,28,0)} }
</style>
<body>
  <h1>Sound detector → Teams alert via Power Automate</h1>

  <p>
    This page listens to your microphone (after you click Start and grant permission).  
    If the microphone level stays above the chosen threshold for longer than the hold period,  
    it will send a GET request directly into the hard-coded Power Automate flow URL.  
    That Flow can then post into Teams or take any other action you configure.
  </p>

  <fieldset>
    <legend>Settings</legend>
    <div class="row">
      <div>
        <label>RMS threshold (sensitivity)</label>
        <input id="threshold" type="number" step="0.005" min="0.005" value="0.02">
        <small>Lower = more sensitive, higher = less sensitive. RMS is a measure of loudness.</small>
      </div>
      <div>
        <label>Hold seconds</label>
        <input id="holdSecs" type="number" min="0.2" step="0.1" value="2">
        <small>How long the level must stay above the threshold before triggering.</small>
      </div>
      <div>
        <label>Cooldown seconds</label>
        <input id="cooldown" type="number" min="0" value="30">
        <small>Minimum gap between alerts even if noise continues.</small>
      </div>
    </div>
  </fieldset>

  <div class="row">
    <button id="startBtn">Start</button>
    <button id="stopBtn" disabled>Stop</button>
    <button id="wakeBtn" title="Keep screen awake">Screen wake lock</button>
  </div>

  <div id="alert" class="alert">
    Threshold held for over <span id="holdTarget">2</span> seconds. Alert sent to Power Automate.
  </div>

  <fieldset>
    <legend>Live display</legend>
    <label>Current RMS (sound level)</label>
    <meter id="meter" min="0" max="0.2" value="0"></meter>

    <label style="margin-top:.75rem;">Hold progress (seconds above threshold)</label>
    <meter id="holdMeter" min="0" max="2" value="0"></meter>

    <div class="status" id="status">Idle</div>
    <div class="status" id="lastSent">Last sent: never</div>
    <div class="status" id="holdInfo">Held above threshold: 0.00s</div>
  </fieldset>

<script>
// ------------------- CONFIGURATION -------------------
// Hard-coded Power Automate Flow URL.
// Treat this URL as a secret – anyone with it can trigger your Flow.
const FLOW_URL = "https://defaultbd4e2dd1acd14501bd6e37bb4d3ad5.f4.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/cf92882cc04c4c6da093b041163e32c1/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ciG1F1FHrfp8cPXr-_BCRsaJ7xraoiVyqljTBAgmefI";

// ------------------- STATE -------------------
let ac, mic, analyser, rafId, wakeLock;
let lastTime = 0, holdMs = 0;
let sentForCurrentHold = false;
let lastSentAt = 0;

// ------------------- DOM ELEMENTS -------------------
const els = {
  meter: document.getElementById('meter'),
  holdMeter: document.getElementById('holdMeter'),
  status: document.getElementById('status'),
  lastSent: document.getElementById('lastSent'),
  holdInfo: document.getElementById('holdInfo'),
  alert: document.getElementById('alert'),
  holdTarget: document.getElementById('holdTarget'),
  startBtn: document.getElementById('startBtn'),
  stopBtn: document.getElementById('stopBtn'),
  wakeBtn: document.getElementById('wakeBtn'),
  threshold: document.getElementById('threshold'),
  holdSecs: document.getElementById('holdSecs'),
  cooldown: document.getElementById('cooldown')
};

// ------------------- CORE FUNCTIONS -------------------
async function start() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    ac = new (window.AudioContext || window.webkitAudioContext)();
    mic = ac.createMediaStreamSource(stream);
    analyser = ac.createAnalyser();
    analyser.fftSize = 2048;
    mic.connect(analyser);

    holdMs = 0;
    sentForCurrentHold = false;
    lastTime = performance.now();
    els.holdTarget.textContent = String(parseFloat(els.holdSecs.value || '2'));

    loop();
    els.startBtn.disabled = true;
    els.stopBtn.disabled = false;
    setStatus('Listening');
  } catch (e) {
    console.error(e);
    setStatus('Mic permission denied or unavailable');
  }
}

function stop() {
  cancelAnimationFrame(rafId);
  if (ac) ac.close();
  ac = mic = analyser = null;
  els.startBtn.disabled = false;
  els.stopBtn.disabled = true;
  setStatus('Stopped');
  setAlert(false);
}

function setStatus(t) { els.status.textContent = t; }
function setAlert(on) { els.alert.classList.toggle('on', on); }

function rmsFromTimeDomain(buf) {
  let sum = 0;
  for (let i = 0; i < buf.length; i++) sum += buf[i] * buf[i];
  return Math.sqrt(sum / buf.length);
}

// Fire a GET to the Flow URL with some query parameters.
// Uses an Image beacon to avoid CORS issues.
function sendGet(rms) {
  const qs = new URLSearchParams({
    event: 'sound_hold_reached',
    rms: rms.toFixed(4),
    ts: Math.floor(Date.now() / 1000).toString(),
    source: 'web-mic'
  });
  const img = new Image();
  img.src = `${FLOW_URL}&${qs.toString()}`;
  lastSentAt = Date.now();
  els.lastSent.textContent = `Last sent: ${new Date(lastSentAt).toLocaleString()}`;
}

function loop() {
  const thresh = parseFloat(els.threshold.value || '0.02');
  const holdSecs = Math.max(0.2, parseFloat(els.holdSecs.value || '2'));
  const cooldownMs = Math.max(0, parseInt(els.cooldown.value || '30', 10) * 1000);

  els.holdMeter.max = holdSecs;
  els.holdTarget.textContent = String(holdSecs);

  const now = performance.now();
  const dt = now - lastTime;
  lastTime = now;

  const buf = new Float32Array(analyser.fftSize);
  analyser.getFloatTimeDomainData(buf);
  const rms = rmsFromTimeDomain(buf);
  els.meter.value = Math.min(0.2, rms);

  const over = rms >= thresh;

  if (over) {
    holdMs += dt;
    if (!sentForCurrentHold && holdMs >= holdSecs * 1000 && Date.now() - lastSentAt >= cooldownMs) {
      setAlert(true);
      setStatus(`Hold reached. rms=${rms.toFixed(4)}. Sending GET`);
      sendGet(rms);
      sentForCurrentHold = true;
    }
  } else {
    holdMs = 0;
    if (sentForCurrentHold) {
      sentForCurrentHold = false; // re-arm
      setAlert(false);
    }
  }

  els.holdMeter.value = holdMs / 1000;
  els.holdInfo.textContent = `Held above threshold: ${(holdMs/1000).toFixed(2)}s`;

  if (!sentForCurrentHold) {
    setStatus(`Listening, rms=${rms.toFixed(4)}`);
  }

  rafId = requestAnimationFrame(loop);
}

// Optional: stop the screen from sleeping so the loop keeps running
async function toggleWake() {
  if ('wakeLock' in navigator) {
    if (!wakeLock) {
      wakeLock = await navigator.wakeLock.request('screen');
      els.wakeBtn.textContent = 'Release wake lock';
      wakeLock.addEventListener('release', () => els.wakeBtn.textContent = 'Screen wake lock');
    } else {
      await wakeLock.release();
      wakeLock = null;
      els.wakeBtn.textContent = 'Screen wake lock';
    }
  } else {
    alert('Wake lock API not supported on this browser');
  }
}

// ------------------- WIRE UP BUTTONS -------------------
els.startBtn.addEventListener('click', start);
els.stopBtn.addEventListener('click', stop);
els.wakeBtn.addEventListener('click', toggleWake);
</script>
</body>
</html>
