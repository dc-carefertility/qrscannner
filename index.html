<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Code Scanner</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html5-qrcode/2.3.8/html5-qrcode.min.js"
          integrity="sha512-r6rDA7W6ZeQhvl8S7yRVQUKVHdexq+GAlNkNNqVC7YyIV+NwqCTJe2hDWCiffTyRNOeGEzRRJ9ifvRm/HCzGYg=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
    #reader { width: 100%; max-width: 480px; margin: 20px auto; display:none; }
    #output, #log { margin-top: 20px; word-break: break-word; }
    #output { font-size: 1.2em; font-weight: bold; }
    #controls select, #controls button, #zoomSlider { margin: 5px; padding: 8px 12px; font-size: 1em; }
    #controls { display: none; margin: 15px 0; }
    #startBtn, #newScanBtn { padding: 10px 20px; font-size: 1.1em; }
    #log {
      background: #f0f0f0; border: 1px solid #ccc; padding: 10px;
      max-height: 150px; overflow-y: auto; font-size: 0.85em; white-space: pre-wrap;
    }
    #version {
      position: fixed; top: 10px; right: 10px;
      background: #333; color: #fff; padding: 4px 8px;
      font-size: 0.8em; border-radius: 4px; opacity: 0.8;
    }
    #zoomContainer { display: none; margin-top: 10px; }

    #label-container { display: none; margin-top: 20px; }
    .label {
      width: 5cm; height: 2.5cm;
      padding: 0.3cm; box-sizing: border-box;
      font-size: 9pt; font-family: Arial, sans-serif;
      border: 1px solid #000; margin: 0 auto;
      text-align: left;
    }
    .label div { margin-bottom: 2mm; line-height: 1.2em; }

    @media print {
      body * { visibility: hidden; }
      #print-label, #print-label * { visibility: visible; }
      #print-label { position: absolute; left: 0; top: 0; }
    }
  </style>
</head>
<body>
<div id="version">v0.0.18</div>

<h1>QR Code Scanner</h1>

<button id="startBtn">Scan QR Code</button>

<div id="controls">
  <select id="cameraSelect"></select>
  <button id="torchBtn">Toggle Torch</button>
  <button id="focusBtn">Refocus</button>
  <button id="cancelBtn">Cancel Scan</button>
  <div id="zoomContainer">
    <label for="zoomSlider">Zoom:</label>
    <input type="range" id="zoomSlider" min="1" max="1" step="0.1" value="1" />
  </div>
</div>

<div id="reader"></div>
<div id="output"></div>
<button id="newScanBtn" style="display:none;">Scan New QR</button>

<!-- Printable Label -->
<div id="label-container">
  <div id="print-label">
    <div class="label">
      <div><strong>Name:</strong> <span id="field-name"></span></div>
      <div><strong>Number:</strong> <span id="field-number"></span></div>
      <div><strong>DOB:</strong> <span id="field-dob"></span> &nbsp;&nbsp; <strong>SEX:</strong> <span id="field-sex"></span></div>
      <div><strong>Date/Time:</strong> <span id="field-datetime"></span></div>
      <div><strong>Signed:</strong> ____________________________</div>
    </div>
  </div>
  <button onclick="window.print()">üñ®Ô∏è Print Label</button>
</div>

<div id="log">[debug]</div>

<script>
  const startBtn = document.getElementById('startBtn');
  const controlsDiv = document.getElementById('controls');
  const cameraSelect = document.getElementById('cameraSelect');
  const readerDiv = document.getElementById('reader');
  const outputDiv = document.getElementById('output');
  const newScanBtn = document.getElementById('newScanBtn');
  const torchBtn = document.getElementById('torchBtn');
  const focusBtn = document.getElementById('focusBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const zoomSlider = document.getElementById('zoomSlider');
  const zoomContainer = document.getElementById('zoomContainer');

  let html5QrCode;
  let currentCameraId = null;
  let torchOn = false;
  let scanning = false;
  let timeoutHandle = null;
  let videoTrack = null;

  function log(msg){
    console.log(msg);
    const logDiv = document.getElementById('log');
    logDiv.textContent += `\n${msg}`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function showStartState(){
    startBtn.style.display = 'inline-block';
    controlsDiv.style.display = 'none';
    readerDiv.style.display = 'none';
    newScanBtn.style.display = 'none';
    outputDiv.textContent = '';
    zoomContainer.style.display = 'none';
    document.getElementById('label-container').style.display = 'none';
    clearTimeout(timeoutHandle);
  }

  function showScanningState(){
    startBtn.style.display = 'none';
    controlsDiv.style.display = 'block';
    readerDiv.style.display = 'block';
    newScanBtn.style.display = 'none';
    outputDiv.textContent = 'Scanning‚Ä¶';
  }

  function showResultState(){
    startBtn.style.display = 'none';
    controlsDiv.style.display = 'none';
    readerDiv.style.display = 'none';
    newScanBtn.style.display = 'inline-block';
    zoomContainer.style.display = 'none';
  }

  function populateCameras(devices){
    cameraSelect.innerHTML = '';
    devices.forEach((device, idx)=>{
      const opt = document.createElement('option');
      opt.value = device.id;
      opt.text = device.label || `Camera ${idx+1}`;
      cameraSelect.appendChild(opt);
    });
    const saved = localStorage.getItem('lastCameraId');
    if(saved && devices.find(d=>d.id===saved)){
      cameraSelect.value = saved;
    }
  }

  async function setupZoom(track){
    const capabilities = track.getCapabilities();
    if(capabilities.zoom){
      log(`üîç Zoom supported: ${JSON.stringify(capabilities.zoom)}`);
      zoomSlider.min = capabilities.zoom.min;
      zoomSlider.max = capabilities.zoom.max;
      zoomSlider.step = capabilities.zoom.step || 0.1;
      zoomSlider.value = track.getSettings().zoom || capabilities.zoom.min;
      zoomSlider.oninput = async () => {
        try {
          await track.applyConstraints({ advanced: [{ zoom: parseFloat(zoomSlider.value) }] });
          log("Zoom set to " + zoomSlider.value);
        } catch (e) {
          log("‚ö†Ô∏è Zoom error: " + e);
        }
      };
      zoomContainer.style.display = 'block';
    } else {
      log("‚ùå Zoom not supported on this device");
      zoomContainer.style.display = 'none';
    }
  }

  function startScanner(){
    currentCameraId = cameraSelect.value;
    localStorage.setItem('lastCameraId', currentCameraId);
    if(!html5QrCode) html5QrCode = new Html5Qrcode("reader");
    showScanningState();
    log("Starting camera: " + currentCameraId);

    html5QrCode.start(
      currentCameraId,
      { fps: 10, qrbox: { width: 300, height: 300 } },
      onScanSuccess,
      onScanFailure
    ).then(()=>{
      scanning = true;
      setTimeout(() => {
        const videoEl = document.querySelector("#reader video");
        const stream = videoEl?.srcObject;
        videoTrack = stream?.getVideoTracks?.()[0];
        if(videoTrack){
          log("‚úÖ Video track obtained from DOM");
          setupZoom(videoTrack);
        } else {
          log("‚ùå Failed to get video track ‚Äî zoom will be unavailable.");
        }
      }, 500);

      timeoutHandle = setTimeout(()=>{
        if(scanning){
          log('Timeout: no scan after 2 minutes');
          stopScanner();
          showStartState();
        }
      }, 120000);
    }).catch(err=>{
      log("Start error: " + err);
      outputDiv.textContent = "Start error: " + err;
      showStartState();
    });
  }

  function stopScanner(){
    clearTimeout(timeoutHandle);
    if(html5QrCode){
      html5QrCode.stop().then(()=> log("Camera stopped."))
                        .catch(e=>log("Stop error: " + e));
    }
    scanning = false;
    videoTrack = null;
    zoomContainer.style.display = 'none';
  }

  function onScanSuccess(decodedText){
    if(!scanning) return;
    scanning = false;
    log("Decoded: " + decodedText);
    stopScanner();
    showResultState();
    outputDiv.textContent = `‚úÖ Scanned: ${decodedText}`;

    const parts = decodedText.split(",");
    if (parts.length >= 6) {
      document.getElementById('field-name').textContent = parts[1];
      document.getElementById('field-number').textContent = parts[0];
      document.getElementById('field-dob').textContent = parts[4];
      document.getElementById('field-sex').textContent = parts[5];

      const now = new Date();
      const pad = n => n.toString().padStart(2, '0');
      const timestamp = `${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
      document.getElementById('field-datetime').textContent = timestamp;

      document.getElementById('label-container').style.display = 'block';
    }
  }

  function onScanFailure(error){
    // silent
  }

  async function toggleTorch(){
    if(!videoTrack) return;
    try {
      torchOn = !torchOn;
      await videoTrack.applyConstraints({ advanced: [{ torch: torchOn }] });
      log(`Torch ${torchOn ? 'ON' : 'OFF'}`);
    } catch(e) {
      log("Torch not supported: " + e);
    }
  }

  async function requestFocus(){
    if(!videoTrack) return;
    try {
      await videoTrack.applyConstraints({ advanced: [{ focusMode: "continuous" }] });
      log("Focus requested");
    } catch(e) {
      log("Focus not supported: " + e);
    }
  }

  startBtn.addEventListener('click', startScanner);
  cameraSelect.addEventListener('change', ()=> {
    if(scanning){ stopScanner(); startScanner(); }
  });
  cancelBtn.addEventListener('click', ()=>{ stopScanner(); showStartState(); });
  newScanBtn.addEventListener('click', showStartState);
  torchBtn.addEventListener('click', toggleTorch);
  focusBtn.addEventListener('click', requestFocus);

  Html5Qrcode.getCameras().then(devices=> {
    if(devices.length){ populateCameras(devices); }
    else { outputDiv.textContent = 'No cameras found.'; log('No cameras found.'); }
  }).catch(err=> {
    outputDiv.textContent = 'Camera error: ' + err;
    log('Camera error: ' + err);
  });

  showStartState();
</script>
</body>
</html>
